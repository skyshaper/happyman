- hosts: all
  roles:
    - common
- hosts: development
  tasks:
    - name: install test ircd
      apt: pkg=ngircd
    - include: happyman.yml application_directory=/vagrant cpanm_with_develop=yes
- hosts: production
  roles:
    - nginx
  tasks:
    - name: install supervisor
      apt: pkg={{item}}
      with_items:
        - supervisor
    - name: configure nginx proxy to happyman
      copy:
        src=files/etc/nginx/sites-available/happyman
        dest=/etc/nginx/sites-available/happyman
      notify:
        - reload nginx
    - name: enable nginx proxy to happyman
      file:
        path=/etc/nginx/sites-enabled/happyman
        src=/etc/nginx/sites-available/happyman
        state=link
      notify:
        - reload nginx
    - name: get code
      git: repo=https://github.com/skyshaper/happyman.git dest=/opt/happyman
      notify:
        - restart happyman
      register: git_result
    - include: happyman.yml application_directory=/opt/happyman
      when: git_result.changed == True
    - name: create happyman user
      user: name=happyman system=yes home=/opt/happyman createhome=no shell=/bin/zsh
      notify:
        - restart happyman
    - name: create supervisor config
      copy:
        src=files/etc/supervisor/conf.d/happyman.conf
        dest=/etc/supervisor/conf.d/happyman.conf
      notify:
        - restart happyman
    - name: create happyman config
      copy:
        src=files/opt/happyman/happyman.conf
        dest=/opt/happyman/happyman.conf
      notify:
        - restart happyman
  handlers:
    - name: restart happyman
      supervisorctl: name=happyman state=restarted
